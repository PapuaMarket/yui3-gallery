<!doctype html>
<html>
<head>
    <title>Injection Engine Tests</title>    
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?3.3.0/build/cssreset/reset-min.css&3.3.0/build/cssfonts/fonts-min.css">
    <link rel="stylesheet" type="text/css" href="../../ura/assets/srp.css">
    <script type="text/javascript" src="http://yui.yahooapis.com/3.3.0/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

    <h1>Injection Engine Tests</h1>

    <div>
      <div id="hd">
          <form id="sf" name="s" method="get" action="http://search.yahoo.com/search" accept-charset="utf-8" role="search">
              <div class="bd">
                  <ul class="tabs" id="tabs">
                      <li class="on"> &nbsp; </li>
                  </ul>
                  <div id="sbx">
                      <label for="yschsp" class="off-left">Search query</label><input type="text" class="sbq" id="yschsp" name="p" value="" tabindex="1" autocomplete="off"><input type="submit" class="sbb" value="Search" tabindex="2"><input type="hidden" name="fr2" value="sb-top"><input type="hidden" name="tmpl" value="QI007">
                  </div>
                  <div id="at" class="sa-hidden">
                      <h2 class="off-left">Search Assist</h2>
                  </div>
              </div>
          </form>
      </div>
    </div>

<script src="/jute_docs/jute.js"></script>
<script type="text/javascript" src="../../../build/ura-injection/ura-injection-debug.js?coverage=1"></script>
<script type="text/javascript">
YUI({
    useConsoleOutput: true,
    logInclude: { TestRunner: true }
}).use('test', 'console', 'ura-injection', 'jute', function (Y) {

  (new Y.Console({
      verbose: true,
      newestOnTop: false,
      height: '500px',
      width: '99%',
      style: 'block'
  })).render();
  
  Y.namespace("Tests");

  Y.Tests.App = (function() {

      var Assert = Y.Assert,
          ObjectAssert = Y.ObjectAssert;

      //-------------------------------------------------------------------------
      // Base Test Suite
      //-------------------------------------------------------------------------
      var suite = new Y.Test.Suite("App Tests");

      //-------------------------------------------------------------------------
      // Test Case for encoding
      //-------------------------------------------------------------------------
      
      suite.add(new Y.Test.Case({

          name: "Simple App Tests",

          //---------------------------------------------
          // Setup and tear down
          //---------------------------------------------
          setUp: function() {
          },

          tearDown: function() {
              if (this.ura) {
                  this.ura.destroy();
                  this.ura = null;
              }
              if (Y.one('iframe')) {
                  Y.one('iframe').remove();
              }
              // removing all listeners
              Y.one('#hd').purge(true);
              Y.one('doc').focus();
          },

          //---------------------------------------------------------------------
          // Tests
          //---------------------------------------------------------------------

          testInit: function() {
              this.ura = new Y.URA({
                    searchbox: '#yschsp',
                    sbc: '#sbx', // searchbox container
                    urc: '#at',  // ura container
                    hclass: 'sa-hidden',
                    fclass: 'shl-reg'
              });
              Assert.isObject(this.ura, 'URA Phanton object was not defined correctly');
          },

          testAttributePropagation: function() {
              var b = {};
              this.ura = new Y.URA({
                    searchbox: '#yschsp',
                    sbc: '#sbx', // searchbox container
                    urc: '#at',  // ura container
                    hclass: 'sa-hidden',
                    fclass: 'shl-reg',
                    // some of them have default configuration
                    url: 'default-url',
                    pubid: 1,
                    linkParams: {
                        z: 1
                    }
              });
              // mocking the real URA object
              this.ura.connect({
                  sandbox: {
                      on: function(){},
                      set: function (name, value) {
                          b[name] = value;
                      }
                  },
                  suggest: function(){},
                  tray: {
                      on: function () {}
                  }
              });
              // testing default value
              Assert.areEqual(b.url, 'default-url', 'The default value for url is not set.');
              Assert.isUndefined(b.rmp, 'The default value for rmp should be undefined.');
              Assert.areEqual(b.pubid, 1, 'The default numeric value for pubid is not set.');
              Assert.isObject(b.linkParams, 'The default object for linkParams is not set.');
              Assert.areEqual(b.linkParams.z, 1, 'The default numeric value for linkParams.z is not set.');
              // setting custom values
              this.ura.set('rmp', 'custom-rmp');
              this.ura.set('url', 'custom-url');
              this.ura.set('pubid', 'custom-pubid');
              this.ura.set('linkStem', 'custom-linkStem');
              this.ura.set('linkParams', {g: 9});
              // testing custom value
              Assert.areEqual(this.ura.get('rmp'), 'custom-rmp', 'The custom value for rmp is not set locally as expected.');
              Assert.areEqual(b.url, 'custom-url', 'The custom value for url is not propagated correctly.');
              Assert.areEqual(b.pubid, 'custom-pubid', 'The custom value for pubid is not propagated correctly.');
              Assert.areEqual(b.linkStem, 'custom-linkStem', 'The custom value for linkStem is not propagated correctly.');
              Assert.areEqual(b.linkParams.g, 9, 'The custom value for linkParams is not propagated correctly.');
              // testing undefined value
              this.ura.set('foo', 2);
              Assert.isUndefined(b.foo, 'The custom value for foo is been propagated when it should not be propagated.');
              this.ura.set('rmp', undefined);
              Assert.isUndefined(b.rmp, 'The custom value for rmp is not undefined after setting it to undefined.');
              this.ura.set('rmp', false);
              Assert.isFalse(b.rmp, 'The custom value for rmp is not False after setting it to FALSE.');
              this.ura.set('rmp', '');
              Assert.areEqual(b.rmp, '', 'The custom value for rmp is not empty after setting it to empty string.');
          },

          testCustomBeacons: function() {
              var b = {};
              this.ura = new Y.URA({
                    searchbox: '#yschsp',
                    sbc: '#sbx', // searchbox container
                    urc: '#at',  // ura container
                    hclass: 'sa-hidden',
                    fclass: 'shl-reg',
                    pv: {
                        a: 2
                    }
              });
              // mocking the real URA object
              this.ura.connect({
                  sandbox: {
                      on: function(){},
                      set: function (name, value) {
                          b[name] = value;
                      }
                  },
                  suggest: function(){},
                  tray: {
                      on: function () {}
                  }
              });
              Assert.isNotUndefined(b.pv, 'The default value for beacons is not propagated correctly.');
              Assert.areEqual(b.pv.a, 2, 'The default value for beacons is not propagated as an object.');
              this.ura.set('pv', {
                  c: 1
              });
              Assert.areEqual(b.pv.c, 1, 'The raw beacons definition is not propagated correctly.');
          },

          testBeaconEvents: function() {
              var b, p, sandbox = new Y.Base({});
              this.ura = new Y.URA({
                    searchbox: '#yschsp',
                    sbc: '#sbx', // searchbox container
                    urc: '#at',  // ura container
                    hclass: 'sa-hidden',
                    fclass: 'shl-reg'
              });
              // mocking the real URA object
              this.ura.connect({
                  sandbox: sandbox,
                  suggest: function(){},
                  tray: {
                      on: function () {}
                  }
              });
              this.ura.on('log:pv:o', function (e) {
                  b = true;
                  p = e.params;
              });
              sandbox.fire ('log:pv', {
                  id: 'o',
                  params: {
                      a: 1
                  }
              });
              Assert.isNotUndefined(b, 'The log:pv event was not correctly propagated.');
              Assert.areEqual(p.a, 1, 'The log:pv:o event is not propagating the beacon parameters.');
          }

      }));

      //return it
      return suite;

  })();

  //add to the testrunner and run
  Y.Test.Runner.add(Y.Tests.App);
  // executing JUTE is posible to get coverage
  ( Y.UnitTest ? Y.UnitTest.go() : Y.Test.Runner.run() );

});
</script>
</body>
</html>